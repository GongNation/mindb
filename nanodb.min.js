pe.findOne=function(){var selector=typeof arguments[0]=='object'?arguments[0]:{};var options=arguments.length>2?arguments[1]:{};var callback=arguments[arguments.length-1];var result=null;function check(item,_id){if(jS(selector)==='{}')return true;if(selector._id===_id)return true;for(var key in selector){if(item[key]!==selector[key])return false;}return true;}for(var i=0;i<this.indexes.length;i++){if(check(this.collection[this.indexes[i]],this.indexes[i])){result=this.collection[this.indexes[i]];result._id=this.indexed[i];break;}}if(result){callback(null,result);}else{callback(new Error('Not item found.'));}return this;};nanoCollection.prototype.findById=function(_id,callback){if(this.indexes.indexOf(_id)!==-1){var doc=this.collection[_id];doc._id=_id;return callback(null,doc);}else{callback(new Error('Not item found.'));}return this;};nanoCollection.prototype.insert=function(doc,callback){var store=nano.dbs[this.parent].option.store;var last=this.indexes[this.indexes.length-1];if(last){var theNew=last.substr(0,last.length-1)+(Number(last.substr(last.length-1))+1);}else{var theNew=btoa('nano'+this.name)+Math.random().toString().substr(2)+'0';}this.indexes.push(theNew);this.collection[theNew]=doc;store.set('nano-'+this.parent+'-'+this.name,btoa(cP(jS(this.collection))));store.set('nano-'+this.parent+'-'+this.name+'-indexes',btoa(cP(jS(this.indexes))));this.emit('insert',doc);callback();return this;};nanoCollection.prototype.update=function(){var store=nano.dbs[this.parent].option.store;var spec=arguments[0];var doc=arguments[1];var callback=arguments[arguments.length-1];var options=(arguments.length===4?arguments[2]:{});this.findOne(spec,function(err,item){if(err)return callback(err);for(var key in doc){item[key]=doc[key];}this.collection[item._id]=item;store.set('nano-'+this.parent+'-'+this.name,btoa(cP(jS(this.collection))));store.set('nano-'+this.parent+'-'+this.name+'-indexes',btoa(cP(jS(this.indexes))));this.emit('update',item);callback(null,item);});return this;};nanoCollection.prototype.remove=function(selector){var callback=typeof arguments[arguments.length-1]=='function'?arguments[arguments.length-1]:false;selector=selector||{};var store=nano.dbs[this.parent].option.store;function check(item){if(jS(selector)==='{}')return true;for(var key in selector){if(item[key]!==selector[key])return false;}return true;}var res=[];var i=0;var f=this.indexes.length;for(var i=f-1;i>=0;i--){if(check(this.collection[this.indexes[i]])){var t=this.collection[this.indexes[i]];t._id=this.indexes[i];res.push(t);t=null;delete this.collection[this.indexes[i]];this.indexes.splice(i,1);}}if(i==0)return callback(new Error('Not items matched'));store.set('nano-'+this.parent+'-'+this.name,btoa(cP(jS(this.collection))));store.set('nano-'+this.parent+'-'+this.name+'-indexes',btoa(cP(jS(this.indexes))));this.emit('remove',res);if(callback)callback(null,res);return this;};nanoCollection.prototype.on=function(event,fn){if(!this._events)this._events={};if(!this._events[event])return this._events[event]=[fn];this._events[event].push(event);return this;};nanoCollection.prototype.emit=function(){var event=arguments[0];if(!this._events)return false;var handler=this._events[event];if(!handler)return false;if(isArray(handler)){var l=arguments.length;var args=new Array(l-1);for(var i=1;i<l;i++){args[i-1]=arguments[i];}var listeners=handler.slice();for(var i=0,l=listeners.length;i<l;i++){listeners[i].apply(this,args);}return true;}else{return false;}};addEvent(w,'storage',function(evt){if(!/^nano/.test(evt.key)){return;}elseif(/^nano-([\w]+)-([\w]+)-indexes$/.test(evt.key)){var foo=evt.key.match(/nano-([\w]+)-([\w]+)/);var dbName=foo[1];var collname=foo[2];var collection=jP(uCP(atob(store.get('nano-'+dbName+'-'+collName))));var indexes=jP(uCP(atob(store.get('nano-'+dbName+'-'+collName+'-indexes'))));var theNew=collection[indexes[indexes.length-1]];theNew._id=indexes[indexes.length-1];nano.dbs[dbName].collections[collname].emit('storage',theNew);}else{return;}});function nanoCursor(collection,collName){this.collection=collection;this.parent=collName;}nanoCursor.prototype.toArray=function(callback){if(this.collection.length!==0){callback(null,this.collection);}else{callback(new Error('Not item found.'));}return this;};nanoCursor.prototype.limit=function(count){this.collection=this.collection.slice(0,count);return this;};nanoCursor.prototype.sort=function(option){for(var key in option){this.collection.sort(function(a,b){if(option[key]==-1){return a[key]<b[key]?1:-1;}else{return a[key]>b[key]?1:-1;}});}return this;};nanoCursor.prototype.skip=function(count){this.collection=this.collection.splice(conunt);return this;};nanoCursor.prototype.each=function(fn){this.collection.forEach(fn);return this;};if(w.define)w.define(nano);return nano;})(window,document);